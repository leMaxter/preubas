<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Asesor de Maquillaje AI</title>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet" />

  <!-- MediaPipe Face Detection & Camera Utils -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <style>
    /* ==== Variables de color y estilos base ==== */
    :root {
      --color-fondo: #faf8f5;
      --color-principal: #e48fb0;      /* Rosa maquillaje */
      --color-secundario: #4a4a4a;     /* Gris oscuro para texto */
      --color-acento: #f2c1d1;         /* Rosa claro */
      --color-card: #ffffff;          /* Blanco para tarjetas */
      --sombra-card: rgba(0, 0, 0, 0.1);
      --radios-bordes: 12px;
      --font-heading: 'Poppins', sans-serif;
      --font-body: 'Poppins', sans-serif;
    }

    /* ==== Reset y base ==== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background-color: var(--color-fondo);
      font-family: var(--font-body);
      color: var(--color-secundario);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 1rem;
    }
    h1 {
      font-family: var(--font-heading);
      font-size: 2.4rem;
      font-weight: 700;
      color: var(--color-principal);
      margin-bottom: 0.5rem;
      text-align: center;
    }
    p.subtitle {
      font-size: 1rem;
      color: var(--color-secundario);
      margin-bottom: 1.5rem;
      text-align: center;
      max-width: 400px;
      line-height: 1.4;
    }

    /* ==== Contenedor principal ==== */
    .contenedor {
      width: 100%;
      max-width: 420px;
      background-color: var(--color-card);
      border-radius: var(--radios-bordes);
      box-shadow: 0 4px 12px var(--sombra-card);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    /* ==== Video y canvas ==== */
    .video-wrapper {
      position: relative;
      width: 100%;
      padding-bottom: 75%; /* 4:3 ratio */
      border-radius: var(--radios-bordes);
      overflow: hidden;
      border: 2px solid var(--color-acento);
      margin-bottom: 1rem;
    }
    #videoElement {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: var(--radios-bordes);
    }
    #canvas {
      display: none; /* Lo mantenemos oculto */
    }

    /* ==== Bot√≥n estilizado ==== */
    #capture {
      width: 100%;
      padding: 0.75rem;
      background: var(--color-principal);
      color: #fff;
      border: none;
      border-radius: var(--radios-bordes);
      font-size: 1.1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.3s ease;
      margin-bottom: 1rem;
    }
    #capture:hover {
      background: darken(var(--color-principal), 10%);
    }
    #capture:active {
      transform: scale(0.98);
    }

    /* ==== Resultado ==== */
    #result {
      background-color: var(--color-card);
      padding: 1rem;
      border-radius: var(--radios-bordes);
      box-shadow: 0 2px 8px var(--sombra-card);
      font-size: 0.95rem;
      line-height: 1.5;
      color: var(--color-secundario);
    }
    #result h3 {
      font-family: var(--font-heading);
      color: var(--color-principal);
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
    }
    #result h4 {
      font-family: var(--font-heading);
      color: var(--color-principal);
      font-size: 1rem;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
    }
    #result ul {
      margin-left: 1rem;
      list-style-type: disc;
      margin-bottom: 0.75rem;
    }
    #result ul li {
      margin-bottom: 0.4rem;
    }
    #result p {
      margin-bottom: 0.6rem;
    }

    /* ==== Responsividad ==== */
    @media (max-width: 480px) {
      .contenedor {
        padding: 1rem;
      }
      h1 {
        font-size: 2rem;
      }
      #capture {
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <h1>Asesor de Maquillaje AI</h1>
  <p class="subtitle">
    Descubre tu tono de piel y recibe recomendaciones de maquillaje en segundos. Simplemente ac√©rcate a la c√°mara y pulsa ‚ÄúAnalizar‚Äù.
  </p>

  <div class="contenedor">
    <!-- Video Wrapper para aspecto responsivo y bordes redondeados -->
    <div class="video-wrapper">
      <video id="videoElement" autoplay muted playsinline></video>
      <canvas id="canvas" width="320" height="240"></canvas>
    </div>

    <button id="capture">üåü Analizar</button>

    <div id="result">
      Esperando detecci√≥n de rostro...
    </div>
  </div>

  <script>
    // ==== Variables globales ====
    const video = document.getElementById("videoElement");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const captureButton = document.getElementById("capture");
    const resultDiv = document.getElementById("result");

    let lastBox = null;
    let deteccionActiva = false;

    // Canvas auxiliar para muestrear piel (100√ó100 px)
    const canvasPiel = document.createElement("canvas");
    canvasPiel.width = canvasPiel.height = 100;

    // ==== 1) Configurar Face Detection ====
    const faceDetector = new FaceDetection({
      locateFile: (file) =>
        `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}`,
    });
    faceDetector.setOptions({
      modelSelection: 0,
      minDetectionConfidence: 0.4,
    });
    faceDetector.onResults((results) => {
      if (results.detections.length > 0) {
        lastBox = results.detections[0].boundingBox;
        if (!deteccionActiva) {
          deteccionActiva = true;
          resultDiv.textContent = "‚úîÔ∏è Rostro detectado. Pulsa ‚ÄòAnalizar‚Äô para ver tu recomendaci√≥n.";
        }
      } else {
        lastBox = null;
        if (deteccionActiva) {
          deteccionActiva = false;
          resultDiv.textContent = "‚ö†Ô∏è No se detecta rostro.";
        }
      }
    });

    // ==== 2) Iniciar c√°mara + MediaPipe loop ====
    function iniciarCamara() {
      navigator.mediaDevices
        .getUserMedia({ video: { facingMode: "user" } })
        .then((stream) => {
          video.srcObject = stream;
          video.onloadedmetadata = () => {
            video.play();
            new Camera(video, {
              onFrame: async () => {
                await faceDetector.send({ image: video });
              },
              width: 320,
              height: 240,
            }).start();
          };
        })
        .catch((err) => {
          console.error("Error al acceder a la c√°mara:", err);
          resultDiv.textContent = "‚ùå No se pudo acceder a la c√°mara.";
        });
    }

    // ==== 3) Funciones para conversi√≥n RGB ‚Üí CIELAB ====
    function pivotRgb(u) {
      return u > 0.04045 ? Math.pow((u + 0.055) / 1.055, 2.4) : u / 12.92;
    }
    function rgbToLab(r, g, b) {
      let rn = r / 255, gn = g / 255, bn = b / 255;
      const rLin = pivotRgb(rn);
      const gLin = pivotRgb(gn);
      const bLin = pivotRgb(bn);
      let X = rLin * 0.4124564 + gLin * 0.3575761 + bLin * 0.1804375;
      let Y = rLin * 0.2126729 + gLin * 0.7151522 + bLin * 0.0721750;
      let Z = rLin * 0.0193339 + gLin * 0.1191920 + bLin * 0.9503041;
      const Xn = 0.95047, Yn = 1.00000, Zn = 1.08883;
      X /= Xn; Y /= Yn; Z /= Zn;
      function f(t) {
        return t > 0.008856 ? Math.cbrt(t) : (7.787 * t) + (16 / 116);
      }
      const fx = f(X), fy = f(Y), fz = f(Z);
      const L = (Y > 0.008856) ? (116 * fy - 16) : (903.3 * Y);
      const a = 500 * (fx - fy);
      const bVal = 200 * (fy - fz);
      return [L, a, bVal];
    }
    function calcularLabPromedio(canvasPiel) {
      const ctx2 = canvasPiel.getContext("2d");
      const imgData = ctx2.getImageData(0, 0, canvasPiel.width, canvasPiel.height).data;
      let sumL = 0, sumA = 0, sumB = 0;
      const totalPx = imgData.length / 4;
      for (let i = 0; i < imgData.length; i += 4) {
        const r = imgData[i], g = imgData[i + 1], b = imgData[i + 2];
        const [L, a, bVal] = rgbToLab(r, g, b);
        sumL += L;
        sumA += a;
        sumB += bVal;
      }
      return [sumL / totalPx, sumA / totalPx, sumB / totalPx];
    }

    // ==== 4) Extraer regi√≥n de mejilla ====
    function extraerRegionMejilla() {
      if (!lastBox) return null;
      const { xCenter, yCenter, width: wNorm, height: hNorm } = lastBox;
      const boxW = wNorm * canvas.width;
      const boxH = hNorm * canvas.height;
      const boxX = (xCenter - wNorm / 2) * canvas.width;
      const boxY = (yCenter - hNorm / 2) * canvas.height;
      const subW = boxW / 2;
      const subH = boxH / 2;
      const subX = boxX + boxW / 2;
      const subY = boxY + boxH / 2;
      const sx = Math.max(0, subX);
      const sy = Math.max(0, subY);
      const sw = Math.min(subW, canvas.width - sx);
      const sh = Math.min(subH, canvas.height - sy);
      const ctx2 = canvasPiel.getContext("2d");
      ctx2.clearRect(0, 0, canvasPiel.width, canvasPiel.height);
      ctx2.drawImage(canvas, sx, sy, sw, sh, 0, 0, 100, 100);
      return canvasPiel;
    }

    // ==== 5) Clasificar tono/subtono ====
    function clasificarTonoSubtono([Lm, aM, bM]) {
      let tono;
      if (Lm >= 75) tono = "Muy claro";
      else if (Lm >= 60) tono = "Claro";
      else if (Lm >= 45) tono = "Medio";
      else if (Lm >= 30) tono = "Oscuro";
      else tono = "Muy oscuro";

      let subtono;
      if (aM >= 5 && bM >= 5) subtono = "C√°lido";
      else if (aM <= -5 && bM <= -5) subtono = "Fr√≠o";
      else subtono = "Neutro";

      return { tono, subtono };
    }

    // ==== 6) Sugerencias de maquillaje ====
    function sugerirMaquillaje(tono, subtono) {
      const recomendaciones = {
        "Muy claro": {
          C√°lido: {
            tipoBase: "Base ligera con subtono dorado",
            paletaSombras: "Sombras en tonos durazno y dorado claro",
            rubor: "Rubor en tono melocot√≥n suave",
            labial: "Labial coral claro",
            consejo: "Usa iluminador en p√≥mulos para realzar tu luminosidad."
          },
          Fr√≠o: {
            tipoBase: "Base ligera con subtono rosado",
            paletaSombras: "Sombras en tonos rosa p√°lido y gris perla",
            rubor: "Rubor rosa fr√≠o suave",
            labial: "Labial rosa empolvado",
            consejo: "Evita tonos demasiado amarillos; resalta con rubor fr√≠o."
          },
          Neutro: {
            tipoBase: "Base ligera neutra",
            paletaSombras: "Sombras en tonos beige y champ√°n",
            rubor: "Rubor color rosa natural",
            labial: "Labial nude rosado",
            consejo: "Un bronzer suave puede dar calidez sin exagerar."
          }
        },
        "Claro": {
          C√°lido: {
            tipoBase: "Base media con matiz dorado",
            paletaSombras: "Sombras c√°lidas (naranja quemado, cobre)",
            rubor: "Rubor coral medio",
            labial: "Labial coral intenso",
            consejo: "Opta por polvos transl√∫cidos para controlar brillos."
          },
          Fr√≠o: {
            tipoBase: "Base media con matiz rosado",
            paletaSombras: "Sombras en tonos lavanda y taupe fr√≠o",
            rubor: "Rubor rosa medio",
            labial: "Labial berry ligero",
            consejo: "Sombras fr√≠as contrastan muy bien en piel clara."
          },
          Neutro: {
            tipoBase: "Base media neutra",
            paletaSombras: "Sombras nude y marrones claros",
            rubor: "Rubor rosa-neutro",
            labial: "Labial nude equilibrado",
            consejo: "Un contorno suave en mejillas da definici√≥n."
          }
        },
        "Medio": {
          C√°lido: {
            tipoBase: "Base media con subtono dorado intenso",
            paletaSombras: "Sombras tierra, oro antiguo, bronce",
            rubor: "Rubor terracota",
            labial: "Labial naranja quemado",
            consejo: "Ilumina con dorado bajo ceja y p√≥mulo."
          },
          Fr√≠o: {
            tipoBase: "Base media con subtono rosado neutro",
            paletaSombras: "Sombras grises, mauve y ciruela suave",
            rubor: "Rubor rosado intenso",
            labial: "Labial frambuesa",
            consejo: "Sombras ahumadas grises dan profundidad."
          },
          Neutro: {
            tipoBase: "Base media neutra",
            paletaSombras: "Sombras nude-rosadas y caf√© suave",
            rubor: "Rubor rosa-terroso",
            labial: "Labial nude con toque c√°lido",
            consejo: "Bronzer suave define sin romper neutralidad."
          }
        },
        "Oscuro": {
          C√°lido: {
            tipoBase: "Base media-alta con subtono dorado oscuro",
            paletaSombras: "Sombras cobre, oro viejo, bronce intenso",
            rubor: "Rubor terracota profundo",
            labial: "Labial rojo anaranjado intenso",
            consejo: "Iluminador dorado en p√≥mulos realza tu piel."
          },
          Fr√≠o: {
            tipoBase: "Base media-alta con subtono rosado oscuro",
            paletaSombras: "Sombras berenjena, gris oscuro, azul petr√≥leo",
            rubor: "Rubor borgo√±a oscuro",
            labial: "Labial vino",
            consejo: "Sombras fr√≠as intensas resaltan en piel oscura."
          },
          Neutro: {
            tipoBase: "Base media-alta neutra",
            paletaSombras: "Sombras caf√© profundo y taupe neutro",
            rubor: "Rubor rosa-terroso profundo",
            labial: "Labial nude-marr√≥n medio",
            consejo: "Contorno suave con bronzer mate define rasgos."
          }
        },
        "Muy oscuro": {
          C√°lido: {
            tipoBase: "Base alta con subtono dorado profundo",
            paletaSombras: "Sombras cobre intenso y dorado oscuro",
            rubor: "Rubor profundo color arcilla",
            labial: "Labial borgo√±a c√°lido",
            consejo: "Iluminador bronce en p√≥mulos crea glow c√°lido."
          },
          Fr√≠o: {
            tipoBase: "Base alta con subtono rosado profundo",
            paletaSombras: "Sombras ciruela profundo y gris ahumado",
            rubor: "Rubor rojo oscuro fr√≠o",
            labial: "Labial morado intenso",
            consejo: "Sombras fr√≠as aportan contraste espectacular."
          },
          Neutro: {
            tipoBase: "Base alta neutra",
            paletaSombras: "Sombras marr√≥n oscuro y taupe profundo",
            rubor: "Rubor vino-neutro",
            labial: "Labial nude-marr√≥n oscuro",
            consejo: "Contorno y bronzer mate resaltan facciones."
          }
        }
      };
      return recomendaciones[tono][subtono];
    }

    // ==== 7) Funci√≥n principal de an√°lisis ====
    function procesarColorCara() {
      if (!lastBox) {
        resultDiv.textContent = "‚ö†Ô∏è No se detecta rostro actualmente.";
        return;
      }
      // Dibujamos el v√≠deo en el canvas principal
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // Extraemos la regi√≥n de mejilla
      const regionPielCanvas = extraerRegionMejilla();
      if (!regionPielCanvas) {
        resultDiv.textContent = "‚ùå No se pudo extraer la regi√≥n de la piel.";
        return;
      }

      // Calculamos L*, a*, b* promedio
      const [Lm, aM, bM] = calcularLabPromedio(regionPielCanvas);

      // Clasificamos
      const { tono, subtono } = clasificarTonoSubtono([Lm, aM, bM]);

      // Obtenemos recomendaciones
      const rec = sugerirMaquillaje(tono, subtono);

      // Mostramos resultado
      resultDiv.innerHTML = `
        <h3>Resultados</h3>
        <p><strong>Tono de piel:</strong> ${tono} (L* = ${Lm.toFixed(1)})</p>
        <p><strong>Subtono:</strong> ${subtono} (a* = ${aM.toFixed(1)}, b* = ${bM.toFixed(1)})</p>
        <hr>
        <h4>Recomendaci√≥n de maquillaje:</h4>
        <ul>
          <li><strong>Base:</strong> ${rec.tipoBase}</li>
          <li><strong>Sombras:</strong> ${rec.paletaSombras}</li>
          <li><strong>Rubor:</strong> ${rec.rubor}</li>
          <li><strong>Labial:</strong> ${rec.labial}</li>
        </ul>
        <p><em>Consejo:</em> ${rec.consejo}</p>
      `;
    }

    captureButton.addEventListener("click", () => {
      resultDiv.textContent = "üîÑ Analizando color de piel...";
      procesarColorCara();
    });

    // ==== Arrancar todo al cargar la p√°gina ====
    window.addEventListener("load", iniciarCamara);
  </script>
</body>
</html>
